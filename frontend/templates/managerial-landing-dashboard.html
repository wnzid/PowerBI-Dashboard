{% extends "base.html" %}
{% block title %}Managerial Dashboard – KPI Overview{% endblock %}
{% block extra_head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='Css/style.css') }}" />
{% endblock %}
{% block content %}
<div class="app-container">
  <nav class="sidebar">
    <div class="logo">
      <img src="{{ url_for('static', filename='Assets/logo.png') }}" alt="Analytics Institute Logo" />
      <h2>Analytics Institute</h2>
    </div>
    <ul class="nav-links">
      <li class="active"><a href="{{ url_for('dashboard.dashboard') }}">Dashboard</a></li>
      <li><a href="{{ url_for('main.coming_soon', page='create-dashboard') }}">Create Dashboard</a></li>
      <li><a href="{{ url_for('main.coming_soon', page='download-data') }}">Download Data</a></li>
      {% if current_user.role.name.lower() == 'admin' %}
      <li><a href="{{ url_for('dashboard.import_data') }}">Import Data</a></li>
      {% endif %}
      <li><a href="{{ url_for('main.coming_soon', page='settings') }}">Settings</a></li>
    </ul>
  </nav>
  <main class="main-content">
    <header class="topbar">
      <div class="menu-links">
        <a href="{{ url_for('main.coming_soon', page='file') }}">File</a>
        <a href="{{ url_for('main.coming_soon', page='data') }}">Data</a>
        <a href="{{ url_for('main.coming_soon', page='export') }}">Export</a>
        <a href="{{ url_for('main.coming_soon', page='analysis') }}">Analysis</a>
        <a href="{{ url_for('main.coming_soon', page='download') }}">Download</a>
        <a href="{{ url_for('main.help_page') }}">Help</a>
      </div>
    
    </header>
    <section class="dashboard-header">
      <h1>Managerial Dashboard</h1>
      <div class="input-group my-3 dashboard-search">
        <span class="input-group-text" id="search-label"><i class="fas fa-search"></i></span>
        <input type="text" id="searchInput" class="form-control" placeholder="Search data" aria-label="Search" aria-describedby="search-label">
      </div>
    </section>
    <section class="dashboard-body">
      <div class="charts-grid">
        <div class="chart-card">
          <h3>Current Student vs Enrolled</h3>
          <a class="view-report" href="{{ url_for('main.coming_soon', page='current-student') }}">View Report</a>
          <canvas id="chart-current-enrolled"></canvas>
        </div>
        <div class="chart-card">
          <h3>Enrolled Vs Offer</h3>
          <a class="view-report" href="{{ url_for('main.coming_soon', page='enrolled-offer') }}">View Report</a>
          <canvas id="chart-enrolled-offer"></canvas>
        </div>
        <div class="chart-card">
          <h3>Visa Breakdown</h3>
          <a class="view-report" href="{{ url_for('main.coming_soon', page='visa-breakdown') }}">View Report</a>
          <canvas id="chart-visa-breakdown"></canvas>
        </div>
        <div class="chart-card">
          <h3>Offer Expiry Surge</h3>
          <a class="view-report" href="{{ url_for('main.coming_soon', page='offer-expiry') }}">View Report</a>
          <canvas id="chart-offer-expiry-surge"></canvas>
        </div>
      </div>
      <aside class="kpi-storyboards">
        <h2 class="kpi-storyboards__title">Storyboards</h2>
        <div class="kpi-card blue">
          <h4>Due Payments</h4>
          <p id="story-due-payments"></p>
        </div>
        <div class="kpi-card orange">
          <h4>Course Performance</h4>
          <p id="story-course-performance"></p>
        </div>
      <div class="kpi-card green">
        <h4>Top Study Reasons</h4>
        <p id="story-study-reasons"></p>
      </div>
      </aside>
      <div class="mt-4">
        <iframe title="Manager Report" width="100%" height="600" src="https://app.powerbi.com/view?r=MANAGER_REPORT_ID" frameborder="0" allowfullscreen="true"></iframe>
      </div>

      <div class="mt-5">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="mb-0">Recently Imported Data</h2>
          {% if current_user.role.name.lower() == 'admin' %}
          <a class="btn btn-success" href="{{ url_for('dashboard.import_data') }}">Import Data</a>
          {% endif %}
        </div>
        <table class="table" id="importedTable">
        <table class="table" id="importedTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Data</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
    <footer class="footer">
      <p>Copyright © 2025 Analytics Institute of Australia</p>
    </footer>
  </main>
</div>
{% endblock %}
{% block extra_js %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="{{ url_for('static', filename='Js/managerial-landing-dashboard.js') }}" defer></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      fetch('/api/imported')
        .then(res => res.json())
        .then(rows => {
          const tbody = document.querySelector('#importedTable tbody');
          rows.forEach(r => {
            const tr = document.createElement('tr');
            const approveBtn = r.approved ? '' : `<form method="post" action="/approve/${r.id}"><button class="btn btn-sm btn-primary">Approve</button></form>`;
            tr.innerHTML = `<td>${r.id}</td><td><pre>${JSON.stringify(r.data)}</pre></td><td>${r.approved ? 'Published' : 'Pending'}</td><td>${approveBtn}</td>`;
            tbody.appendChild(tr);
          });
        });
    });
  </script>
{% endblock %}
